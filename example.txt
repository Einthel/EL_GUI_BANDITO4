def compile_ui_files_recursively(ui_dir, output_dir):
    """
    Рекурсивно находит и компилирует все .ui файлы в .py,
    из директории ui_dir в директорию output_dir.
    Перекомпилирует, только если .py файл отсутствует или .ui файл новее.
    """
    if not os.path.isdir(ui_dir):
        print(f"ОШИБКА: Директория с UI-файлами не найдена: {ui_dir}")
        return
    if not os.path.isdir(output_dir):
        print(f"ОШИБКА: Директория для скомпилированных файлов не найдена: {output_dir}")
        return
        
    for root, _, files in os.walk(ui_dir):
        for ui_file in files:
            if not ui_file.endswith(".ui"):
                continue

            ui_path = os.path.join(root, ui_file)
            
            # Generate the name for the .py file (e.g., widget.ui -> ui_widget.py)
            base_name = os.path.splitext(ui_file)[0]
            py_file_name = f"ui_{base_name}.py"
            # Сохраняем .py файл в корневой директории вывода
            py_path = os.path.join(output_dir, py_file_name)

            # Recompile if .py file is missing or .ui is newer
            recompile = False
            if not os.path.exists(py_path):
                recompile = True
                print(f"Файл '{py_path}' не найден. Требуется компиляция.")
            elif os.path.getmtime(ui_path) > os.path.getmtime(py_path):
                recompile = True
                print(f"Изменения в '{ui_path}'. Требуется перекомпиляция.")

            if recompile:
                print(f"Компиляция '{ui_path}' -> '{py_path}'...")
                try:
                    # Using check=True to raise an exception on error
                    subprocess.run(
                        ['pyside6-uic', ui_path, '-o', py_path], 
                        check=True,
                        capture_output=True, # Hide verbose output unless there's an error
                        text=True
                    )
                    print("Компиляция прошла успешно.")
                except FileNotFoundError:
                    print("\n" + "="*50)
                    print("ОШИБКА: Команда 'pyside6-uic' не найдена.")
                    print("Пожалуйста, убедитесь, что 'pyside6-tools' установлен.")
                    print("Вы можете установить его командой: pip install pyside6-tools")
                    print("="*50)
                    sys.exit(1)
                except subprocess.CalledProcessError as e:
                    print(f"\n" + "="*50)
                    print(f"ОШИБКА: Не удалось скомпилировать '{ui_path}'.")
                    print(f"Детали:\n{e.stderr}")
                    print("="*50)
                    # We exit here because a failed UI compile is a critical error
                    sys.exit(1